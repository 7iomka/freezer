/*
freezer v0.3.0
https://github.com/arqex/freezer
GNU-v2: https://github.com/arqex/freezer/raw/master/LICENSE
*/
!function(e,t){"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?module.exports=t():e.Freezer=t()}(this,function(){"use strict";var e=new Function("return this")(),t={extend:function(e,t){for(var n in t)e[n]=t[n];return e},createNonEnumerable:function(e,t){var n={};for(var r in e)n[r]={value:e[r]};return Object.create(t||{},n)},error:function(e){var t=new Error(e);if(console)return console.error(t);throw t},each:function(e,t){var n,r,i;if(e&&e.constructor==Array)for(n=0,r=e.length;r>n;n++)t(e[n],n);else for(i=Object.keys(e),n=0,r=i.length;r>n;n++)t(e[i[n]],i[n])},addNE:function(e,t){for(var n in t)Object.defineProperty(e,n,{enumerable:!1,configurable:!0,writable:!0,value:t[n]})},nextTick:function(){function t(){for(;r=i.shift();)r();s=!1}function n(e){i.push(e),s||(s=!0,c())}var r,i=[],s=!1,o=!!e.postMessage,a="nexttick",c=function(){return o?function(){e.postMessage(a,"*")}:function(){setTimeout(function(){f()},0)}}(),f=function(){return o?function(n){n.source===e&&n.data===a&&(n.stopPropagation(),t())}:t}();return o&&e.addEventListener("message",f,!0),n.removeListener=function(){e.removeEventListener("message",f,!0)},n}()},n={on:function(e,t,n){var r=this._events[e]||[];return r.push({callback:t,once:n}),this._events[e]=r,this},once:function(e,t){this.on(e,t,!0)},off:function(e,t){if("undefined"==typeof e)this._events={};else if("undefined"==typeof t)this._events[e]=[];else{var n,r=this._events[e]||[];for(n=r.length-1;n>=0;n--)r[n]===t&&r.splice(n,1)}return this},trigger:function(e){var t,n,r=[].slice.call(arguments,1),i=this._events[e]||[],s=[];for(t=0;t<i.length;t++)n=i[t],n.callback?n.callback.apply(null,r):n.once=!0,n.once&&s.push(t);for(t=s.length-1;t>=0;t--)i.splice(s[t],1);return this}},r=t.createNonEnumerable(n),i=function(e){var t={};for(var n in e)t[n]={writable:!0,configurable:!0,enumerable:!1,value:e[n]};return t},s={set:function(e,t){var n=e;return"undefined"!=typeof t&&(n={},n[e]=t),this.__.notify("replace",this,n)},getPaths:function(){return this.__.notify("path",this)},getListener:function(){return this.__.notify("listener",this)}},o=Object.create(Array.prototype,i(t.extend({push:function(e){return this.append([e])},append:function(e){return e&&e.length?this.__.notify("splice",this,[this.length,0].concat(e)):this},pop:function(){return this.length?this.__.notify("splice",this,[this.length-1,1]):this},unshift:function(e){return this.prepend([e])},prepend:function(e){return e&&e.length?this.__.notify("splice",this,[0,0].concat(e)):this},shift:function(){return this.length?this.__.notify("splice",this,[0,1]):this},splice:function(){return this.__.notify("splice",this,arguments)}},s)));Object.defineProperty(o,"length",{configurable:!1,enumerable:!1,get:function(){return Object.keys(this).length},set:function(e){for(var t in this)t>e&&delete this[t]}});var a={Hash:Object.create(Object.prototype,i(t.extend({remove:function(e){var t=[],n=e;!e.constructor==Array&&(n=[e]);for(var r=0,i=n.length;i>r;r++)this.hasOwnProperty(n[r])&&t.push(n[r]);return t.length?this.__.notify("remove",this,t):this}},s))),List:o},c={freeze:function(e,n){if(e&&e.__)return e;var r,i,s=this;return r=Object.create(e.constructor==Array?a.List:a.Hash),t.addNE(r,{__:{listener:!1,parents:[],notify:n}}),t.each(e,function(e,t){i=e&&e.constructor,(i==Array||i==Object)&&(e=s.freeze(e,n)),e&&e.__&&s.addParent(e,r),r[t]=e}),Object.freeze(r),r},update:function(e,n,r){return this[e]?this[e](n,r):t.error("Unknown update type: "+e)},reset:function(e,t){var n;return t&&t.__?(n=t,n.__.listener=t.__.listener,n.__.parents=[]):n=this.freeze(e,e.__.notify),n},replace:function(e,n){var r,i,s,o,a=this,c=this.copyMeta(e),f=e.__.notify;t.each(e,function(t,s){return o=t&&t.__,o&&a.removeParent(t,e),(r=n[s])?(i=r&&r.constructor,(i==Array||i==Object)&&(r=a.freeze(r,f)),r&&r.__&&a.addParent(r,c),delete n[s],void(c[s]=r)):(o&&a.addParent(t,c),c[s]=t)});for(s in n)r=n[s],i=r&&r.constructor,(i==Array||i==Object)&&(r=a.freeze(r,f)),r&&r.__&&r.__.parents.push(e),c[s]=r;return Object.freeze(c),this.refreshParents(e,c),c},remove:function(e,n){var r,i=this,s=this.copyMeta(e);return t.each(e,function(t,o){r=t&&t.__,r&&i.removeParent(t,e),-1==n.indexOf(o)&&(r&&i.addParent(t,s),s[o]=t)}),Object.freeze(s),this.refreshParents(e,s),s},splice:function(e,n){var r,i,s=this,o=this.copyMeta(e),a=n[0],c=a+n[1],f=e.__.notify;if(t.each(e,function(t,n){t&&t.__&&(s.removeParent(t,e),(a>n||n>=c)&&s.addParent(t,o)),o[n]=t}),n.length>1)for(var u=n.length-1;u>=2;u--)i=n[u],r=i&&i.constructor,(r==Array||r==Object)&&(i=this.freeze(i,f)),i&&i.__&&this.addParent(i,o),n[u]=i;return Array.prototype.splice.apply(o,n),Object.freeze(o),this.refreshParents(e,o),o},refresh:function(e,n,r){var i=this,s=this.copyMeta(e);t.each(e,function(t,o){t==n&&(t=r),t&&t.__&&(i.removeParent(t,e),i.addParent(t,s)),s[o]=t}),Object.freeze(s),this.refreshParents(e,s)},copyMeta:function(e){var n;n=Object.create(e.constructor==Array?a.List:a.Hash);var r=e.__;return t.addNE(n,{__:{notify:r.notify,listener:r.listener,parents:r.parents.slice(0)}}),n},refreshParents:function(e,t){var n,r=e.__;if(this.trigger(t,"update",t),r.parents.length)for(n=r.parents.length-1;n>=0;n--)this.refresh(r.parents[n],e,t);else r.listener&&r.listener.trigger("immediate",t)},removeParent:function(e,t){var n=e.__.parents,r=n.indexOf(t);(r=-1)&&n.splice(r,1)},addParent:function(e,t){var n=e.__.parents,r=n.indexOf(t);-1==r&&(n[n.length]=t)},trigger:function(e,n,r){var i=e.__.listener;i&&!i.ticking&&(i.ticking=!0,t.nextTick(function(){i.ticking=!1,i.trigger(n,r)}))},createListener:function(e){var t=e.__.listener;return t||(t=Object.create(r,{_events:{value:[],writable:!0}}),e.__.listener=t),t}},f=function(e){var n,r=this,i=function(e,r,i){if("path"==e)return c.getPaths(n,r);if("listener"==e)return c.createListener(r);var s=c.update(e,r,i);return s?s:t.error("Can't udpate. The node is not in the freezer.")};n=c.freeze(e,i);var s=n.getListener(),o=!1;s.on("immediate",function(e){n=e,o||(o=!0,t.nextTick(function(){o=!1,r.trigger("update",n)}))}),t.addNE(this,{get:function(){return n},set:function(e){n=i("reset",n,e),n.__.listener.trigger("immediate",n)}}),t.addNE(this,{getData:this.get,setData:this.set}),this._events=[]};return f.prototype=t.createNonEnumerable({},r),f});